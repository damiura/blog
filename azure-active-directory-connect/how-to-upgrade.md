---
title: Azure AD Connect アップグレード手順
date: 2018-08-10
tags:
  - AAD Connect
---



こんにちは。 Azure Identity サポートの谷です。

Azure AD Connect (AADC) のアップグレード手順をご紹介いたします。AADC の更新バージョンのリリース頻度は高く、この 3 カ月でも 3 回更新バージョンがリリースされています。更新には、既知の不具合やセキュリティに関する修正に加えて機能強化も含まれています。そのため、できるだけ安定して AADC を運用いただくうえで弊社としての推奨は以下となります。

- 最新バージョンの利用
- 最低でも 6 カ月毎に最新バージョンへのアップグレード
 
Azure AD Connect: バージョンのリリース履歴  
https://docs.microsoft.com/ja-jp/azure/active-directory/connect/active-directory-aadconnect-version-history
 
なお、サポートという観点では、リリースされている全てのバージョンの AADC が現在サポート対象となります。特定のバージョンの AADC をサポート終了する場合にはアップグレードを実施いただくために十分な期間を設け、ご案内いたしますので、ご安心ください。

(トラブルシューティングなどの中で古いバージョンをご利用されている場合に切り分けのためのバージョンアップをお願いする、より詳細な調査をするためにも、まずアップグレードをお願いするという可能性があることについては予めご承知おきください)
 
## アップグレードの流れ

### AADC 1 台構成の場合

1. バージョンアップ前にサーバーの健全性確認
2. 設定情報 / ルールのバックアップ
3. アップグレード
 
### AADC 2 台以上の構成の場合

1 台構成の場合と同様でも構いませんが、より慎重に行う場合には、バージョンアップ時に片方ずつステージング モードに切り替え、同期処理に影響を与えないように実施することも可能です。この場合には、下記の流れで実施します。

1. バージョンアップ前に両サーバーの健全性確認
2. 設定情報 / ルールのバックアップ
3. 1 台目アップグレード
4. ステージングモードの切り替え
5. アップグレード後の動作確認
6. 2 台目のアップグレード
7. ステージングモードの切り替え
8. アップグレード後の動作確認
9. 必要に応じてステージングモードの切り替え
 
## 手順

### 健全性確認

1. AADC サーバーにてイベント ログ (システム / アプリケーション) にてエラーや警告などの記録がないことを確認します。
2. Synchronization Service Manager にて同期処理にて success 以外の記録がないことを確認します。
 
### 設定情報 / ルールのバックアップ

バックアップは万が一アップグレードが正常に実施できなかった場合に備えて取得いただくことをお勧めしております。正常にアップグレードが行えた場合には特にバックアップからのリストア等は不要となります。問題が生じた場合、リストア可能なのはルールのみとなります。設定情報は記録情報から手動で設定し直す必要があります。

<設定情報の記録>

1. Synchronization Service Manager を起動します。
2. [Connectors] を選択します。
3. オンプレミス AD のコネクタを右クリックし、[Properties] をクリックします。
4. [Configure Directory Partitions] - [Containers] をクリックします。
5. パスワードを入力し、[OK] をクリックします。
6. 同期対象の OU/コンテナの画面ショットを採取するなどし、情報を記録しておきます。
7. [Select Object Types] をクリックします。
8. [Show All] にチェックを入れ、全項目が確認できるように画面ショットを採取します。
9. [Select Attributes] をクリックします。
10. [Show All] にチェックを入れ、全項目が確認できるように画面ショットを採取します。
11. デスクトップなどにある [Azure AD Connect] を実行し、構成ウィザードを開きます。
12. [構成] をクリックします。
13. [現在の構成を表示する] をクリックして、[次へ] をクリックします。
14. 全項目が確認できるように画面ショットを採取します。

<同期ルールのエクスポート>

1. スタート画面より Synchronization Rules Editor を起動します。
2. 全ルールを選択し、[Export] をクリックします。出力されたファイルを保存します (PS1 という拡張子で保存します。)
例) sync_rule.ps1
3. [Direction] より [Outbound] を選択します。
4. 全ルールを選択し、[Export] をクリックします。出力されたファイルを保存します (PS1 という拡張子で保存します。)